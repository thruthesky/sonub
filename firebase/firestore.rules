rules_version = '2';

/**
 * Firestore 보안 규칙
 *
 * Firebase Realtime Database에서 Firestore로 마이그레이션하면서
 * 보안 규칙을 Firestore에 맞게 재작성합니다.
 *
 * 주요 데이터 구조:
 * - users/{uid}: 사용자 데이터
 * - chats/{roomId}: 채팅방 메타데이터
 * - chats/{roomId}/messages/{messageId}: 채팅 메시지 (서브컬렉션)
 * - users/{uid}/chat-joins/{roomId}: 채팅 참여 정보 (서브컬렉션)
 * - users/{uid}/chat-invitations/{roomId}: 채팅 초대장 (서브컬렉션)
 * - users/{uid}/chat-favorites/{favoriteId}: 채팅 즐겨찾기 (서브컬렉션)
 * - chat-room-passwords/{roomId}: 채팅방 비밀번호
 * - chat-room-passwords/{roomId}/tries/{uid}: 비밀번호 시도 기록 (서브컬렉션)
 */

service cloud.firestore {
  match /databases/{database}/documents {

    // ==================== Helper Functions ====================

    /**
     * 사용자가 로그인했는지 확인
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * 현재 사용자의 UID
     */
    function currentUserId() {
      return request.auth.uid;
    }

    /**
     * 특정 사용자가 본인인지 확인
     */
    function isOwner(uid) {
      return isSignedIn() && currentUserId() == uid;
    }

    /**
     * 채팅방 문서 참조 가져오기
     */
    function getChatRoom(roomId) {
      return get(/databases/$(database)/documents/chats/$(roomId));
    }

    /**
     * 채팅방이 존재하는지 확인
     */
    function chatRoomExists(roomId) {
      return exists(/databases/$(database)/documents/chats/$(roomId));
    }

    /**
     * 채팅방의 owner 확인
     */
    function isChatRoomOwner(roomId) {
      return isSignedIn() && getChatRoom(roomId).data.owner == currentUserId();
    }

    /**
     * 채팅방 멤버인지 확인
     */
    function isChatRoomMember(roomId) {
      return isSignedIn() &&
             chatRoomExists(roomId) &&
             (roomId.matches('.*' + currentUserId() + '.*') ||
              (currentUserId() in getChatRoom(roomId).data.members));
    }

    /**
     * 채팅방에 비밀번호가 설정되어 있는지 확인
     */
    function chatRoomHasPassword(roomId) {
      return chatRoomExists(roomId) && getChatRoom(roomId).data.password == true;
    }

    /**
     * 시스템 관리자인지 확인
     * (RTDB의 /system/settings/admins를 사용하므로 Firestore로 마이그레이션 필요)
     */
    function isAdmin() {
      // TODO: Firestore로 마이그레이션 시 시스템 관리자 목록을 Firestore에 저장
      // 현재는 RTDB를 사용하므로 이 함수는 사용 불가
      return false;
    }

    // ==================== Users Collection ====================

    /**
     * 사용자 데이터 (Collection: users)
     *
     * 구조: /users/{uid}
     *
     * 읽기 권한:
     * - 모든 사용자가 읽기 가능 (프로필 조회, 검색 등)
     *
     * 쓰기 권한:
     * - 본인만 자신의 데이터를 쓸 수 있음
     */
    match /users/{uid} {
      // 읽기: 모든 사용자 (로그인 불필요)
      allow read: if true;

      // 쓰기: 본인만 가능
      allow write: if isOwner(uid);

      // Validation: 필수 필드 검증
      allow create: if (
        request.resource.data.uid is string
      );

      allow update: if (
        // uid는 변경 불가
        request.resource.data.uid == resource.data.uid
      );
    }

    // ==================== Chats Collection ====================

    /**
     * 채팅방 메타데이터 (Collection: chats)
     *
     * 구조: /chats/{roomId}
     *
     * 읽기 권한:
     * - 모든 로그인 사용자가 읽기 가능
     *
     * 쓰기 권한:
     * - 생성: 로그인한 사용자이며, type이 'group' 또는 'open'인 경우
     *   (owner와 createdAt은 Cloud Functions에서 자동 생성)
     * - name, description: owner만 수정 가능
     * - password: owner만 설정 가능
     * - members: 본인만 추가/삭제 가능 (단, 비밀번호 설정 시 제한)
     */
    match /chats/{roomId} {
      // 읽기: 로그인한 모든 사용자
      allow read: if isSignedIn();

      // 생성: 로그인한 사용자이며, type이 'group' 또는 'open'인 경우
      // owner와 createdAt은 Cloud Functions에서 자동으로 설정되므로 검증하지 않음
      allow create: if (
        isSignedIn() &&
        (
          request.resource.data.type in ['group', 'open']
        )
      );

      // 업데이트: owner만 name, description, password 수정 가능
      allow update: if (
        isSignedIn() &&
        (
          // owner가 name, description 수정
          (
            isChatRoomOwner(roomId) &&
            (
              request.resource.data.diff(resource.data).affectedKeys().hasOnly(['name', 'description', 'password', 'updatedAt'])
            )
          ) ||
          // 멤버가 members 필드만 수정 (본인 추가/삭제)
          (
            request.resource.data.diff(resource.data).affectedKeys().hasOnly(['members', 'memberCount']) &&
            (
              // 비밀번호가 설정되어 있지 않거나
              !chatRoomHasPassword(roomId) ||
              // owner이거나
              isChatRoomOwner(roomId) ||
              // 이미 멤버인 경우 (퇴장/알림 설정 변경)
              isChatRoomMember(roomId)
            )
          )
        )
      );

      // 삭제: owner만 가능
      allow delete: if isChatRoomOwner(roomId);

      // ==================== Messages Subcollection ====================

      /**
       * 채팅 메시지 (Subcollection: chats/{roomId}/messages)
       *
       * 구조: /chats/{roomId}/messages/{messageId}
       *
       * 읽기 권한:
       * - 로그인 사용자이며,
       *   - roomId에 본인 UID가 포함되거나 (1:1 채팅)
       *   - 채팅방 멤버인 경우
       *
       * 쓰기 권한:
       * - 로그인 사용자이며,
       *   - 새 메시지 생성: roomId에 본인 UID가 포함되거나 채팅방 멤버인 경우
       *   - 기존 메시지 수정/삭제:
       *     - 본인이 작성한 메시지
       *     - 삭제되지 않은 메시지
       *     - 90분 이내 메시지
       */
      match /messages/{messageId} {
        // 읽기: 로그인 사용자 + (roomId에 UID 포함 또는 멤버)
        allow read: if (
          isSignedIn() &&
          (
            roomId.matches('.*' + currentUserId() + '.*') ||
            isChatRoomMember(roomId)
          )
        );

        // 생성: 로그인 사용자 + (roomId에 UID 포함 또는 멤버) + 필수 필드 검증
        allow create: if (
          isSignedIn() &&
          (
            roomId.matches('.*' + currentUserId() + '.*') ||
            isChatRoomMember(roomId)
          ) &&
          request.resource.data.senderUid == currentUserId() &&
          request.resource.data.text is string &&
          request.resource.data.createdAt is timestamp
        );

        // 수정/삭제: 본인이 작성한 메시지 + 삭제되지 않은 메시지 + 90분 이내
        allow update, delete: if (
          isSignedIn() &&
          resource.data.senderUid == currentUserId() &&
          (!('deletedAt' in resource.data) || resource.data.deletedAt == null) &&
          (
            // 90분 = 5,400,000ms
            (request.time.toMillis() - resource.data.createdAt.toMillis()) < 5400000
          )
        );
      }

      // ==================== Members Subcollection ====================

      /**
       * 채팅방 멤버 (Subcollection: chats/{roomId}/members)
       *
       * 구조: /chats/{roomId}/members/{uid}
       *
       * 읽기 권한:
       * - 로그인 사용자이며,
       *   - 채팅방이 오픈 채팅방이거나
       *   - 이미 채팅방 멤버인 경우
       *
       * 쓰기 권한:
       * - 생성: 로그인 사용자가 자기 자신을 멤버로 추가 (오픈 채팅방)
       * - 삭제: 본인의 멤버 문서만 삭제 가능
       */
      match /members/{uid} {
        /**
         * 읽기 권한: 본인의 멤버 문서는 항상 읽기 가능
         * - circular dependency 방지: isChatRoomMember() 함수를 사용하지 않음
         * - 사용자가 자신이 멤버인지 확인하기 위해 자신의 문서를 읽을 수 있어야 함
         */
        allow read: if (
          isSignedIn() &&
          uid == currentUserId()
        );

        /**
         * 생성 권한: 오픈 채팅방이면 본인을 멤버로 추가 가능
         * - 오픈 채팅방(open: true)인 경우에만 자동 입장 허용
         * - 그룹 채팅방은 초대를 통해서만 멤버 추가 가능 (Cloud Functions에서 처리)
         */
        allow create: if (
          isSignedIn() &&
          uid == currentUserId() &&
          chatRoomExists(roomId) &&
          getChatRoom(roomId).data.open == true
        );

        /**
         * 업데이트 권한: 본인의 멤버 문서만 업데이트 가능
         * - 알림 설정(notification) 등 멤버별 설정 변경 시 사용
         */
        allow update: if (
          isSignedIn() &&
          uid == currentUserId()
        );

        /**
         * 삭제 권한: 본인의 멤버 문서만 삭제 가능
         * - 채팅방 퇴장 시 사용
         */
        allow delete: if (
          isSignedIn() &&
          uid == currentUserId()
        );
      }
    }

    // ==================== Chat Joins (User Subcollection) ====================

    /**
     * 채팅 참여 정보 (Subcollection: users/{uid}/chat-joins)
     *
     * 구조: /users/{uid}/chat-joins/{roomId}
     *
     * 읽기/쓰기 권한:
     * - 본인만 자신의 채팅 참여 정보를 읽고 쓸 수 있음
     */
    match /users/{uid}/chat-joins/{roomId} {
      // 읽기/쓰기: 본인만
      allow read, write: if isOwner(uid);
    }

    // ==================== Chat Invitations (User Subcollection) ====================

    /**
     * 채팅 초대장 (Subcollection: users/{uid}/chat-invitations)
     *
     * 구조: /users/{uid}/chat-invitations/{roomId}
     *
     * 읽기 권한:
     * - 본인만 자신의 초대장을 읽을 수 있음
     *
     * 쓰기 권한:
     * - 본인이 삭제하거나
     * - 채팅방 멤버가 초대장을 생성할 수 있음
     */
    match /users/{uid}/chat-invitations/{roomId} {
      // 읽기: 본인만
      allow read: if isOwner(uid);

      // 생성: 채팅방 멤버만 (다른 사용자를 초대)
      allow create: if (
        isSignedIn() &&
        isChatRoomMember(roomId) &&
        request.resource.data.inviterUid == currentUserId() &&
        request.resource.data.createdAt is timestamp
      );

      // 업데이트: 본인만 (status 변경)
      allow update: if isOwner(uid);

      // 삭제: 본인만
      allow delete: if isOwner(uid);
    }

    // ==================== Chat Favorites (User Subcollection) ====================

    /**
     * 채팅 즐겨찾기 (Subcollection: users/{uid}/chat-favorites)
     *
     * 구조: /users/{uid}/chat-favorites/{favoriteId}
     *
     * 읽기/쓰기 권한:
     * - 본인만 자신의 즐겨찾기를 읽고 쓸 수 있음
     */
    match /users/{uid}/chat-favorites/{favoriteId} {
      // 읽기/쓰기: 본인만
      allow read, write: if isOwner(uid);

      // Validation: 필수 필드 검증
      allow create, update: if (
        request.resource.data.name is string &&
        request.resource.data.name.size() > 0 &&
        request.resource.data.name.size() <= 30 &&
        request.resource.data.createdAt is timestamp &&
        request.resource.data.folderOrder is string
      );
    }

    // ==================== Chat Room Passwords ====================

    /**
     * 채팅방 비밀번호 (Collection: chat-room-passwords)
     *
     * 구조: /chat-room-passwords/{roomId}
     *
     * 읽기/쓰기 권한:
     * - password: owner만 읽고 쓸 수 있음
     */
    match /chat-room-passwords/{roomId} {
      // 읽기/쓰기: 채팅방 owner만
      allow read, write: if isChatRoomOwner(roomId);

      // ==================== Password Tries Subcollection ====================

      /**
       * 비밀번호 시도 기록 (Subcollection: chat-room-passwords/{roomId}/tries)
       *
       * 구조: /chat-room-passwords/{roomId}/tries/{uid}
       *
       * 쓰기 권한:
       * - 본인만 자신의 시도 기록을 작성할 수 있음
       */
      match /tries/{uid} {
        // 읽기: 채팅방 owner만
        allow read: if isChatRoomOwner(roomId);

        // 쓰기: 본인만
        allow write: if isOwner(uid);
      }
    }

    // ==================== System (시스템 정보 - 읽기 전용) ====================

    /**
     * 시스템 데이터 (Collection: system)
     *
     * 구조: /system/stats (실시간 통계)
     *
     * Cloud Functions에서만 쓰기 가능
     * 모든 사용자가 읽기 가능
     */
    match /system/{document=**} {
      // 읽기: 모든 사용자 (로그인 불필요)
      allow read: if true;

      // 쓰기: 불가 (Cloud Functions만)
      allow write: if false;
    }

    // ==================== Stats (통계 정보 - 읽기 전용) ====================

    /**
     * 통계 데이터 (Collection: stats)
     *
     * Cloud Functions에서만 쓰기 가능
     * 모든 사용자가 읽기 가능
     */
    match /stats/{document=**} {
      // 읽기: 모든 사용자
      allow read: if true;

      // 쓰기: 불가 (Cloud Functions만)
      allow write: if false;
    }

    // ==================== FCM Tokens ====================

    /**
     * FCM 토큰 (Collection: fcm-tokens)
     *
     * 구조: /fcm-tokens/{token}
     *
     * 읽기/쓰기 권한:
     * - 로그인한 모든 사용자 (토큰 등록/삭제)
     * - 비로그인 사용자도 자신의 토큰 등록 가능 (device 필드만)
     *
     * 참고: specs/sonub-firebase-database-structure.md - FCM 토큰 섹션
     */
    match /fcm-tokens/{token} {
      // 읽기/쓰기: 로그인한 모든 사용자
      allow read, write: if isSignedIn();

      // 쓰기: 비로그인 사용자도 자신의 토큰 등록 가능
      // (device: 'web' 필드만 저장, uid는 나중에 로그인 시 업데이트)
      allow write: if !isSignedIn();
    }

    // ==================== Test Data (QA 전용) ====================

    /**
     * 테스트 데이터 (Collection: test/data)
     *
     * QA 전용 테스트 데이터 노드 - 누구나 읽고 쓰기 가능
     */
    match /test/data/{document=**} {
      allow read, write: if true;
    }
  }
}
