{
  "rules": {
    "users": {
      // 자신만 읽기 가능. 모든 사용자가 읽기 불가능
      ".read": true,
      // 하위 모든 경로 쓰기 삭제: 단, shallower 경로에서 개별 규칙 설정 가능
      ".write": false,
      "$uid": {
        // 2025-12-12 까지는 무조건 쓰기 통과 (테스트 데이터 생성용)
        // 그 이후는 본인만 쓰기 가능
        ".write": "now < 1765555200000 ||
          auth.uid == $uid"
      },
      ".indexOn": [
        "createdAt",
        "displayNameLowerCase",
        "sort_recentWithPhoto",
        "sort_recentFemaleWithPhoto",
        "sort_recentMaleWithPhoto"
      ]
    },
    "system": {
      "settings": {
        "admins": {
          // 로그인한 모든 사용자가 읽기 가능 (메뉴에서 사용)
          ".read": "auth != null",
          // 관리자만 쓰기 가능 (배열에 있는 사용자만)
          ".write": "root.child('system/settings/admins').val().contains(auth.uid)"
        }
      }
    },
    "stats": {
      ".read": true,
      ".write": false,
      "counters": {
        ".read": true,
        ".write": false
      }
    },
    "chat-rooms": {
      // 채팅방 메타데이터
      // createdAt과 owner 필드는 Cloud Functions에서만 설정됨
      ".read": true,
      "$roomId": {
        "owner": {
          // 채팅방이 존재하지 않으면 본인 UID로 설정 가능, 존재하면 수정 불가
          ".write": "!root.child('chat-rooms').child($roomId).exists() &&
            newData.val() === auth.uid",".validate": "newData.isString()"
        },
        "createdAt": {
          // Cloud Functions에서만 설정 가능 (클라이언트는 쓰기 불가)
          ".write": false,
          ".validate": "newData.isNumber()"
        },
        "name": {
          // 채팅방이 존재하지 않으면 누구나 쓰기 가능, 존재하면 owner만 수정 가능
          ".write": "!root.child('chat-rooms').child($roomId).exists() ||
            root.child('chat-rooms').child($roomId).child('owner').val() === auth.uid",".validate": "newData.isString() &&
            newData.val().length > 0 &&
            newData.val().length <= 50"
        },
        "description": {
          // 채팅방이 존재하지 않으면 누구나 쓰기 가능, 존재하면 owner만 수정 가능
          ".write": "!root.child('chat-rooms').child($roomId).exists() ||
            root.child('chat-rooms').child($roomId).child('owner').val() === auth.uid",".validate": "newData.isString() &&
            newData.val().length <= 200"
        },
        "type": {
          ".write": "!data.exists()",
          ".validate": "newData.val() === 'group' ||
            newData.val() === 'open' ||
            newData.val() === 'single'"
        },
        "open": {
          ".write": "!data.exists()",
          ".validate": "newData.isBoolean()"
        },
        "password": {
          ".write": "root.child('chat-rooms').child($roomId).child('owner').val() === auth.uid",
          ".validate": "newData.isBoolean()"
        },
        "groupListOrder": {
          ".write": "!data.exists()",
          ".validate": "newData.isNumber()"
        },
        "openListOrder": {
          ".write": "!data.exists()",
          ".validate": "newData.isNumber()"
        },
        "memberCount": {
          // Cloud Functions에서만 설정 가능 (자동 생성/증감)
          ".write": false,
          ".validate": "newData.isNumber() &&
            newData.val() >= 0"
        },
        "members": {
          "$uid": {
            // 쓰기 권한: 본인만 ($uid === auth.uid)
            // 허용 조건 (OR):
            //   1. data.exists(): 이미 멤버 → 퇴장/알림 설정 변경 가능
            //   2. !password.exists(): 비밀번호 미설정 → 자유롭게 가입 가능
            //   3. owner === auth.uid: Owner → 비밀번호 설정 시에도 가입 가능
            // 비밀번호 설정 시: 일반 사용자는 Cloud Functions를 통해서만 가입 가능
            ".write": "auth != null &&
              $uid === auth.uid &&
              (
                data.exists() ||
                !root.child('chat-rooms').child($roomId).child('password').exists() ||
                root.child('chat-rooms').child($roomId).child('owner').val() === auth.uid
              )",".validate": "newData.isBoolean() ||
              newData.val() === null"
          }
        },
        "$other": {
          ".validate": false
        }
      },
      ".indexOn": [
        "openListOrder"
      ]
    },
    "chat-joins": {
      "$uid": {
        ".indexOn": [
          "allChatListOrder",
          "singleChatListOrder",
          "groupChatListOrder",
          "openChatListOrder",
          "openAndGroupChatListOrder"
        ],
        ".read": "$uid === auth.uid",
        ".write": "$uid === auth.uid"
      }
    },
    "chat-messages": {
      ".read": "auth != null",
      "$messageId": {
        // 읽기 권한: 로그인한 사용자이며, 다음 중 하나에 해당
        //   1. roomId에 본인 UID가 포함됨 (1:1 채팅)
        //   2. 오픈 채팅방
        //   3. 채팅방 멤버
        ".read": "auth != null &&
          (
            data.child('roomId').val().contains(auth.uid) ||
            root.child('chat-rooms').child(data.child('roomId').val()).child('type').val() == 'open' ||
            root.child('chat-rooms').child(data.child('roomId').val()).child('members').child(auth.uid).exists()
          )",

        // 쓰기 권한: 로그인한 사용자이며, 다음 조건을 모두 만족
        ".write": "auth != null &&
          (
            // 조건 1: 채팅방 접근 권한 확인
            // - roomId에 본인 UID가 포함되거나 (1:1 채팅)
            // - 채팅방 멤버인 경우
            (
              newData.child('roomId').val().contains(auth.uid) ||
              root.child('chat-rooms').child(newData.child('roomId').val()).child('members').child(auth.uid).exists()
            )
          ) &&
          (
            // 조건 2: 새 메시지 생성 또는 기존 메시지 수정/삭제 검증
            (
              // 2-1. 새 메시지 생성: 기존 데이터가 없는 경우
              !data.exists()
            ) ||
            (
              // 2-2. 기존 메시지 수정/삭제: 다음 조건을 모두 만족해야 함
              data.exists() &&
              (
                // a) 본인이 작성한 메시지여야 함
                data.child('senderUid').val() === auth.uid
              ) &&
              (
                // b) 삭제되지 않은 메시지여야 함
                !data.child('deleted').val()
              ) &&
              (
                // c) 90분(5,400,000ms) 이내 메시지여야 함
                // now: 현재 시각(밀리초)
                // data.child('createdAt').val(): 메시지 생성 시각(밀리초)
                // 90분 = 90 * 60 * 1000 = 5,400,000ms
                (now - data.child('createdAt').val()) < 5400000
              )
            )
          )"
      },
      ".indexOn": [
        "roomOrder"
      ]
    },
    "chat-invitations": {
      // 채팅 초대 관리
      // 구조: /chat-invitations/{inviteeUid}/{roomId}
      "$uid": {
        // 본인만 자신의 초대 목록을 읽을 수 있음
        ".read": "$uid === auth.uid",
        "$roomId": {
          // 쓰기 규칙: 본인이 삭제하거나, 채팅방 멤버가 초대 생성 가능
          ".write": "auth != null &&
            (
              ($uid === auth.uid && newData.val() === null) ||
              (newData.val() !== null && root.child('chat-rooms').child($roomId).child('members').child(auth.uid).exists())
            )"
        },
        ".indexOn": [
          "invitationOrder"
        ]
      }
    },
    "chat-favorites": {
      // 즐겨찾기 폴더 관리
      // 사용자별로 채팅방을 폴더로 분류하여 관리
      "$uid": {
        ".read": "$uid === auth.uid",
        ".write": "$uid === auth.uid",
        "$favoriteId": {
          "name": {
            // 폴더 이름: 필수, 1-30자
            ".validate": "newData.isString() &&
              newData.val().length > 0 &&
              newData.val().length <= 30"
          },
          "description": {
            // 폴더 설명: 선택, 최대 100자
            ".validate": "newData.isString() &&
              newData.val().length <= 100"
          },
          "createdAt": {
            // 생성 시간: 필수, 숫자 (timestamp)
            ".validate": "newData.isNumber()"
          },
          "folderOrder": {
            // 정렬 순서: 필수, 문자열 (500 prefix = 상단 고정)
            ".validate": "newData.isString()"
          },
          "roomList": {
            // 폴더에 포함된 채팅방 목록 (roomId -> true)
            "$roomId": {
              ".validate": "newData.isBoolean()"
            }
          }
        },
        ".indexOn": [
          "folderOrder"
        ]
      }
    },
    "fcm-tokens": {
      ".read": true,
      ".write": true,
      ".indexOn": [
        "uid"
      ]
    },
    "chat-room-passwords": {
      "$roomId": {
        "password": {
          ".read": "root.child('chat-rooms').child($roomId).child('owner').val() === auth.uid",
          ".write": "root.child('chat-rooms').child($roomId).child('owner').val() === auth.uid"
        },
        "try": {
          "$uid": {
            ".write": "auth != null &&
              $uid === auth.uid"
          }
        }
      }
    },
    "test": {
      "data": {
        // QA 전용 테스트 데이터 노드 - 누구나 읽고 쓰기 가능
        ".read": true,
        ".write": true,
        ".indexOn": [
          "order",
          "createdAt",
          "qnaCreatedAt",
          "reminderCreatedAt",
          "newsCreatedAt"
        ]
      }
    }
  }
}