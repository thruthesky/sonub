다음 버전에 작업을 할 내용 기록
# Sonub 차기 버전 작업 계획

## 1. Firestore 비용 최적화 R&D
- **배경**: 채팅 기능을 전부 Firestore에 저장할 경우 메시지마다 `/chat-joins`, `/users/{uid}/newMessageCount` 등을 갱신하면서 읽기/쓰기 비용이 폭증할 수 있음.
- **트래픽 가정**: 그룹 채팅방 100개 × 방당 1,000명 × 일 100건 메시지 × 파생 업데이트 2회 × 30일 ≈ 6억 회 문서 쓰기 + Cloud Functions 문서 읽기 → Firestore 비용 부담이 큰 구조.

### 1.1 Firestore vs RTDB 비용 비교 (요약)
| 항목 | Firestore | RTDB | 메모 |
|------|-----------|------|------|
| 저장 공간 1GB | 약 \$0.18 | \$5 | Firestore가 20배 이상 저렴 |
| 다운로드 1GB | 약 \$0.12 | \$1 | Firestore가 8배 이상 저렴 |
| 읽기/쓰기 | 과금 O | 과금 X | RTDB는 트랜잭션 비용이 없음 |

> 결론: 저장/다운로드는 Firestore가 거의 공짜에 가깝지만, 초당 수많은 문서 read/write가 발생하면 Firestore가 오히려 비싸질 수 있음.

### 1.2 하이브리드 전략 제안
1. **채팅방 메타와 메시지 본문은 Firestore 유지**  
   - 장점: 낮은 저장/다운로드 비용, 강력한 쿼리/색인.
2. **자주 갱신되는 소량 데이터는 RTDB meta로 분리**  
   - 예: `chat-joins-meta/{roomId}/newMessageCount`, `chat-joins-meta/{roomId}/lastMessageText` 등.
   - 사용자는 `/users/{uid}/chat-joins/{roomId}` 파생 필드를 Firestore에서 조회하고, 새 메시지 수/알림과 같은 실시간 필드는 RTDB meta에서 읽어옴.
3. **필드 단위 실시간 리스닝 최적화**  
   - Firestore에서 문서 전체를 리슨하는 대신, RTDB meta 필드를 리슨하여 자주 변경되는 작은 데이터만 전송.

### 1.3 후속 작업
- RTDB meta 구조 설계 및 Cloud Functions 동기화 로직 초안 작성.
- 하이브리드 운영 시 동기화 일관성/장애 대응 플로우 정의.
- Firestore/RTDB 비용 시뮬레이션과 모니터링 대시보드 준비.

## 2. Firestore vs RTDB 상세 비용 비교

| 항목 | Firestore | Realtime Database | 비고 |
|------|-----------|-------------------|------|
| 저장(GB/월) | 약 \$0.18 (1GB 무료) | \$5 (1GB 무료) | Firestore가 약 20~30배 저렴 |
| 다운로드(GB) | \$0.12 (10GB 무료) → 대량 구간 \$0.11 | \$1 (10GB 무료) | 2TB 전송 시 Firestore ≈\$230, RTDB ≈\$2,000 |
| 읽기/쓰기 | 100k당 \$0.06/0.18, 삭제 \$0.02 | 별도 과금 없음 (트래픽에 포함) | 하루 50k 읽기/20k 쓰기 무료 |
| 동시 연결 | 최대 1M 연결 지원, 리스너 유지 비용 없음 | 인스턴스당 200k 연결, 유지 비용 없음 | 변경 시 Firestore는 읽기 건수, RTDB는 전송 바이트가 과금 |

### 2.1 저장 비용
- Firestore: 5GB 저장 시 무료 1GB 제외 약 \$0.72/월. 사실상 미미.
- RTDB: 5GB 저장 시 무료 1GB 제외 약 \$20/월. 대용량일수록 부담이 큼.

### 2.2 읽기/쓰기 요청
- Firestore: 100만 읽기/일 → 월 3천만 건 → 무료분 제외 약 \$17.1/월. 쓰기 10만/일 → 월 300만 건 → 무료분 제외 약 \$4.32/월. 합계 약 \$20 안팎.
- RTDB: 요청당 비용은 없지만 전송량으로 과금되므로 데이터가 커질수록 다운로드 비용이 누적됨. 문서 크기가 200B 미만일 때만 Firestore보다 유리하다는 사례가 있음.

### 2.3 다운로드(아웃바운드)
- Firestore: 2TB 전송 시 첫 10GB 무료, 이후 구간별 \$0.12~0.11/GB → 약 \$230~240/월.
- RTDB: 2TB 전송 시 (10GB 무료 제외) 2038GB × \$1 = 약 \$2038/월.

### 2.4 동시 연결 및 리스너
- Firestore: 1,000명 수준은 부담 없음. 변경 시 해당 문서가 1,000명에게 전파되면 1,000건의 읽기로 계산.
- RTDB: 동일 변경이 발생하면 데이터 크기 × 접속자 수만큼 트래픽이 발생. GB당 \$1 요율 때문에 업데이트 빈도가 높으면 비용 급증.

### 2.5 무료 할당량
- Firestore/RTDB 모두 1GB 저장, 10GB 전송, 일부 읽기/쓰기 무료지만 본 시나리오 규모(5GB 데이터, 2TB 전송, 일 100만 읽기)에서는 영향 미미.

### 2.6 결론
- 저장·다운로드 측면에서 Firestore가 압도적으로 저렴.
- 읽기/쓰기 비용은 건수 과금인 Firestore가 일반적인 채팅 데이터 패턴에서 유리.
- 대규모 동시 연결에서도 Firestore는 자동 확장과 낮은 비용으로 운영 가능.
- RTDB는 소형·단순 데이터에 강점이 있으나, 대량 트래픽에서는 비용 폭탄 위험이 크므로 Firestore 기반 + RTDB meta 하이브리드가 최적.

### 2.7 참고
- Firebase 공식 요금 문서, 커뮤니티 사례(RTDB → Firestore 전환), 실사용 시뮬레이션 자료 등을 종합해 위 수치를 산정.
