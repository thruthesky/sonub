<script lang="ts">
	/**
	 * 채팅방 비밀번호 설정 컴포넌트 (Owner 전용)
	 *
	 * 채팅방 Owner가 비밀번호를 설정하거나 해제할 수 있는 UI 컴포넌트입니다.
	 *
	 * 주요 기능:
	 * - 비밀번호 활성화/비활성화 토글
	 * - 비밀번호 입력 및 확인
	 * - 최소 4자 유효성 검사
	 * - Firebase RTDB에 저장:
	 *   - /chat-room-passwords/{roomId}/password: 실제 비밀번호 (plain text)
	 *   - /chat-rooms/{roomId}/password: true/false (활성화 플래그)
	 *
	 * @prop roomId - 채팅방 ID
	 * @prop currentPassword - 현재 설정된 비밀번호 (optional)
	 * @prop isPasswordEnabled - 비밀번호 활성화 여부
	 */

	import { Button } from '$lib/components/ui/button';
	import { Input } from '$lib/components/ui/input';
	import { Switch } from '$lib/components/ui/switch';
	import { Label } from '$lib/components/ui/label';
	import { toast } from 'svelte-sonner';
	import { rtdb } from '$lib/firebase';
	import { ref, update, remove } from 'firebase/database';
	import { m } from '$lib/paraglide/messages';

	interface Props {
		roomId: string;
		currentPassword?: string;
		isPasswordEnabled: boolean;
	}

	let { roomId, currentPassword = '', isPasswordEnabled = false }: Props = $props();

	// 상태 변수
	let password = $state(currentPassword);
	let passwordConfirm = $state('');
	let enabled = $state(isPasswordEnabled);
	let isSaving = $state(false);

	/**
	 * 비밀번호 저장 핸들러
	 *
	 * 로직:
	 * 1. enabled === true 인 경우:
	 *    - 비밀번호 유효성 검사 (최소 4자, 비밀번호 일치)
	 *    - /chat-room-passwords/{roomId}/password 에 비밀번호 저장
	 *    - /chat-rooms/{roomId}/password 에 true 저장
	 * 2. enabled === false 인 경우:
	 *    - /chat-room-passwords/{roomId}/password 삭제
	 *    - /chat-rooms/{roomId}/password 에 false 저장
	 */
	async function handleSave() {
		// 0. rtdb null 체크
		if (!rtdb) {
			toast.error(m.chatPasswordSaveFailure());
			return;
		}

		// 1. 유효성 검사 (비밀번호 활성화 시)
		if (enabled) {
			if (password.length < 4) {
				toast.error(m.chatPasswordMinLengthError());
				return;
			}

			if (password !== passwordConfirm) {
				toast.error(m.chatPasswordMismatchError());
				return;
			}
		}

		isSaving = true;

		try {
			if (enabled) {
				// 2. 비밀번호 활성화
				// 2-1. 비밀번호 저장
				await update(ref(rtdb, `chat-room-passwords/${roomId}`), {
					password: password
				});

				// 2-2. 활성화 플래그 저장
				await update(ref(rtdb, `chat-rooms/${roomId}`), {
					password: true
				});

				toast.success(m.chatPasswordSetSuccess());
			} else {
				// 3. 비밀번호 비활성화
				// 3-1. 비밀번호 삭제
				await remove(ref(rtdb, `chat-room-passwords/${roomId}/password`));

				// 3-2. 활성화 플래그 false 설정
				await update(ref(rtdb, `chat-rooms/${roomId}`), {
					password: false
				});

				toast.success(m.chatPasswordRemoveSuccess());
			}
		} catch (error) {
			console.error('❌ 비밀번호 저장 실패:', error);
			toast.error(m.chatPasswordSaveFailure());
		} finally {
			isSaving = false;
		}
	}
</script>

<div class="password-setting-container">
	<!-- 비밀번호 활성화 토글 -->
	<div class="toggle-section">
		<Label for="password-toggle" class="toggle-label">
			{m.chatPasswordEnableToggle()}
		</Label>
		<Switch id="password-toggle" bind:checked={enabled} />
	</div>

	<!-- 비밀번호 입력 필드 (활성화 시에만 표시) -->
	{#if enabled}
		<div class="input-section">
			<Input
				type="password"
				placeholder={m.chatPasswordInputPlaceholder()}
				bind:value={password}
				disabled={isSaving}
			/>

			<Input
				type="password"
				placeholder={m.chatPasswordConfirmPlaceholder()}
				bind:value={passwordConfirm}
				disabled={isSaving}
			/>
		</div>
	{/if}

	<!-- 저장 버튼 -->
	<div class="button-section">
		<Button onclick={handleSave} disabled={isSaving} class="w-full">
			{isSaving ? m.chatPasswordSaving() : m.commonSave()}
		</Button>
	</div>
</div>

<style lang="postcss">
	@import 'tailwindcss' reference;

	/**
	 * 비밀번호 설정 UI 스타일링
	 *
	 * Layout: Tailwind CSS inline classes 사용
	 * Styling: @apply를 통한 Tailwind CSS utility classes 적용
	 */

	.password-setting-container {
		@apply space-y-4;
	}

	.toggle-section {
		@apply flex items-center justify-between;
	}

	.toggle-label {
		@apply text-sm font-medium;
	}

	.input-section {
		@apply space-y-3;
	}

	.button-section {
		@apply pt-2;
	}
</style>
